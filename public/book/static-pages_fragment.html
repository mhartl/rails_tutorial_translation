<div id="top"></div>


<h1 class="chapter"><a id="sec:3" href="static-pages#top" class="heading"><span class="number">Глава 3</span> В основном статические страницы</a></h1>


<p>В этой главе мы начнем разработку примера приложения, которое будет служить нам образцом в остальной части этого учебника. Хотя в примере приложения, в конечном счете будут пользователи, сообщения и полная система входа и аутентификации, мы начнем с, казалось бы, ограниченной темы: создание статических страниц. Несмотря на свою кажущуюся простоту, создание статических страниц весьма поучительное упражнение &mdash; идеальное начало для нашего зарождающегося приложения.</p>

<p>Хотя Rails предназначен для создания динамических веб сайтов, поддерживаемых базой данных, он также хорош при создании статических страниц, которые мы могли бы сделать на чистом HTML. В самом деле, использование Rails даже для статических страниц дает неоспоримое преимущество: мы можем легко добавлять лишь <em>небольшое</em> количество динамического содержания. В этой главе мы узнаем, как. По пути мы получим наш первый опыт <em>автоматического тестирования</em>, которое поможет нам быть более уверенными, в том, что наш код является правильным. Кроме того, хороший набор тестов позволит нам <em> реорганизовывать (refactor)</em> наш код с уверенностью, изменяя его форму, не меняя функций.</p>

<p>как и в <a class="ref" href="a-demo-app#top">Главе&nbsp;2</a>, перед началом работы нам необходимо создать новый проект Rails, который в этот раз назовем <tt>sample_app</tt>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">cd</span> ~/rails_projects
<span class="gp">$</span> rails new sample_app -T
<span class="gp">$</span> <span class="nb">cd </span>sample_app
</pre></div>
</div>


<p>Здесь <code>-T</code> дополнение к <code>rails</code> команде говорит Rails не создавать <code>test</code> директорию, связанную с <tt>Test::Unit</tt> платформой. Это не потому что мы не хотим писать тесты; наоборот, начиная с <a class="ref" href="static-pages#sec:first_tests">Раздела&nbsp;3.2</a> мы будем использовать альтернативную платформу тестирования, называемую <em>RSpec</em> для написания основательного набора тестов.</p>

<p>Как и в <a class="ref" href="a-demo-app#sec:planning_the_application">Разделе&nbsp;2.1</a>, нашим следующим шагом будет использование текстового редактора для дополнения <code>Gemfile</code> гемами, необходимыми нашему приложению. (Напомню, что, в зависимости от вашей системы, вам может потребоваться <tt>1.2.5</tt> версия  <tt>sqlite3</tt> гема.) Также, для примера приложения нам понадобятся два гема, в которых мы ранее не нуждались: гем для RSpec и гем для RSpec библиотеки. Код для их включения показан в <a class="ref" href="static-pages#code:gemfile_rspec">Листинге&nbsp;3.1</a>. (<em>Примечание</em>: если вы хотите установить  <em>все</em> гемы, необходимые для примера приложения, вам следует использовать код из <a class="ref" href="updating-showing-and-deleting-users#code:final_gemfile">Листинга&nbsp;10.42</a> .)</p>

<div class="label" id="code:gemfile_rspec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.1.</span> <span class="description"><code>Gemfile</code> для sample app.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.9&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.3&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;webrat&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.1&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Это включает <tt>rspec-rails</tt> в development, чтобы у нас был доступ к RSpec-специфичным генераторам, и это включает его в test, для запуска тестов. (Мы также включаем gem для <a href="http://github.com/brynary/webrat">Webrat</a>, утилиты тестирования, ранее устанавливавшейся как зависимость, которая теперь должна быть  явно прописанной.) Чтобы установить и включить RSpec гемы, мы, как обычно, используем <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Чтобы заставить Rails использовать RSpec вместо <tt>Test::Unit</tt>, мы должны установить файлы, необходимые RSpec. Это может быть выполнено с <code>rails generate</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate rspec:install
</pre></div>
</div>


<p>Все что нам осталось&nbsp;&mdash;&nbsp;инициализировать Git репозиторий:<sup class="footnote" id="fnref:3.1"><a href="#fn:3.1">1</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git init
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Initial commit&quot;</span>
</pre></div>
</div>


<p>Как и с первым приложением, я советую обновить <code>README</code> файл (находится в корневой директории приложения) чтобы сделать его более полезным и описательным, как показано в <a class="ref" href="static-pages#code:sample_app_readme">Листинг&nbsp;3.2</a>.</p>

<div class="label" id="code:sample_app_readme"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.2.</span> <span class="description">Улучшенный <code>README</code> файл для sample app.</span>
</div>
<div class="code"><div class="highlight"><pre># Ruby on Rails Tutorial: пример приложения

Это пример приложения для
[*Ruby on Rails Tutorial: Learn Rails by Example*](http://railstutorial.org/)
 [Майкл Хартл](http://michaelhartl.com/).
</pre></div>
</div></div>


<p>Затем изменим его расширение на <code>markdown</code> и зафиксируем изменения:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git mv README README.markdown
<span class="gp">$</span> git commit -a -m <span class="s2">&quot;Improved the README&quot;</span>
</pre></div>
</div>




<div class="label" id="fig:create_repository"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/create_repository.png" alt="create_repository" /></span></div><div class="caption"><span class="header">Рисунок  3.1: </span><span class="description">Создание sample app репозитория в GitHub.&nbsp;<a href="http://railstutorial.org/images/figures/create_repository-full.png">(полный размер)</a></span></div></div>


<p>Так как мы будем использовать этот пример приложения в остальной части книги, хорошей идеей будет сделать репозиторий (хранилище) в GitHub (<a class="ref" href="static-pages#fig:create_repository">Рис.&nbsp;3.1</a>) и отправить в него наше приложение:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git remote add origin git@github.com:&lt;username&gt;/sample_app.git
<span class="gp">$</span> git push origin master
</pre></div>
</div>


<p>(Отмечу, что в результате этого шага, репозиторий в <a href="http://github.com/railstutorial/sample_app">http://github.com/railstutorial/sample_app</a> содержит исходный код законченного примера приложения. Можете обращаться к нему за консультациями, с двумя предостережениями: (1) вы узнаете намного больше, если наберете исходный код приложения самостоятельно, нежели полагаясь на законченную версию; (2) Код в книге может немного отличаться от кода в репозитории GitHub. Что связано с тем, что код из репозитория использовался для создания <a href="http://railstutorial.org/screencasts">Rails Tutorial screencasts</a>, в которые включены дополнительные тесты.)</p>

<p>Конечно, можно дополнительно развернуть приложение на Heroku даже на этом раннем этапе:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku create
<span class="gp">$</span> git push heroku master
</pre></div>
</div>


<p>(Если это не работает у вас, см. примечание для <a class="ref" href="beginning#code:gemfile_sqlite_heroku">Листинга&nbsp;1.9</a> для возможного исправления ошибки.) В процессе изучения книги я рекомендую регулярно отправлять и разворачивать приложение:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Теперь, мы готовы начать разработку примера приложения.</p>

<div class="label" id="sec:static_pages"></div>


<h2><a id="sec:3.1" href="static-pages#sec:static_pages" class="heading"><span class="number">3.1</span> Статические страницы</a></h2>


<p>Rails имеет два основных способа создания статических веб-страниц. Во-первых, Рельсы могут обрабатывать <em>истинно</em> статические страницы, состоящие из чистых HTML файлов. Во-вторых, Рельсы могут определить <em>представления</em>, содержащие чистый HTML, которые Рельсы могут <em>интерпретировать</em> таким образом, что веб-сервер сможет отправить их в браузер.</p>

<p>Для того, чтобы сориентироваться, полезно вспомнить структуру каталогов Rails из <a class="ref" href="beginning#sec:the_first_application">Раздела&nbsp;1.2.3</a> (<a class="ref" href="beginning#fig:directory_structure_rails_3">Рис.&nbsp;1.2</a>). В этом разделе мы будем работать в основном в <code>app/controllers</code> и <code>app/views</code> директориях. (В <a class="ref" href="static-pages#sec:first_tests">Разделе&nbsp;3.2</a>, мы даже добавим свою собственную директорию.)</p>

<div class="label" id="sec:truly_static_pages"></div>


<h3><a id="sec:3.1.1" href="static-pages#sec:truly_static_pages" class="heading"><span class="number">3.1.1</span> Истинно статические страницы.</a></h3>


<p>Мы начнем с по-настоящему статичных страниц. Напомним, из <a class="ref" href="beginning#sec:rails_server">Раздела&nbsp;1.2.5</a> что, благодаря <code>rails</code> сценарию, каждое Rails приложение поставляется как минимально рабочее приложение с дефолтной (по умолчанию) страницей приветствия по адресу <a href="http://localhost:3000/"><tt>http://localhost:3000/</tt></a> (<a class="ref" href="beginning#fig:riding_rails_3">Рис.&nbsp;1.3</a>).</p>

<div class="label" id="fig:public_index_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/public_index_rails_3.png" alt="public_index_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  3.2: </span><span class="description">Файл <code>public/index.html</code>.&nbsp;<a href="http://railstutorial.org/images/figures/public_index_rails_3-full.png">(полный размер)</a></span></div></div>


<p>Чтобы узнать, откуда берется эта страница, взгляните на файл <code>public/index.html</code> (<a class="ref" href="static-pages#fig:public_index_rails_3">Рис.&nbsp;3.2</a>).  Он немного грязноват, так как содержит свою собственную информацию о стиле, но он выполняет свою работу: по умолчанию, Rails обрабатывает любые файлы из <code>public</code> каталога, отправляя их непосредственно в браузер.<sup class="footnote" id="fnref:3.2"><a href="#fn:3.2">2</a></sup> В случае специального <code>index.html</code> файла, по умолчанию, вы можете даже не указывать файл в URL, как <code>index.html</code> Хотя вы можете включить его, если хотите; адреса:</p>

<pre class="verbatim">http://localhost:3000/</pre>


<p>и</p>

<pre class="verbatim">http://localhost:3000/index.html</pre>


<p>эквивалентны.</p>

<p>Как и следовало ожидать, если захотим, мы можем сделать наши собственные статичные файлы HTML и положить их в тот же <code>public</code> каталог как и <code>index.html</code>. Например, давайте создадим файл с дружеским приветствием (<a class="ref" href="static-pages#code:hello_world">Листинг&nbsp;3.3</a>):<sup class="footnote" id="fnref:3.3"><a href="#fn:3.3">3</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mate public/hello.html
</pre></div>
</div>


<div class="label" id="code:hello_world"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.3.</span> <span class="description">Обычный файл HTML, с дружеским приветствием.<br /> <code>public/hello.html</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Greeting<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;p&gt;</span>Hello, world!<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>В <a class="ref" href="static-pages#code:hello_world">Листинге&nbsp;3.3</a> мы видим типичную структуру HTML документа: <em>тип документа</em>, или doctype, заявление вверху, говорящее браузерам, какую версию HTML мы используем; (в данном случае, <a   href="http://ru.wikipedia.org/wiki/HTML5">HTML5</a>);<sup class="footnote" id="fnref:3.4"><a href="#fn:3.4">4</a></sup> <code>head</code> раздел, в данном случае с &ldquo;Приветствие&rdquo; внутри <code>title</code> тега; и <code>body</code> раздел, в данном случае с &ldquo;Привет, мир!&rdquo; внутри <code>p</code> (параграф) тега. (Отступ не является обязательным, HTML не чувствителен к пробелам, и игнорирует как табуляции так и пробелы, но это делает структуру документа легко читаемой.) Как и было обещано, при посещении адреса <a  href="http://localhost:3000/hello.html"><tt>http://localhost:3000/hello.html</tt></a>,  Rails незамедлительно его (hello.html) визуализирует (<a class="ref" href="static-pages#fig:hello_world">Рис.&nbsp;3.3</a>). Обратите внимание, что название, отображаемое в верхней части окна браузера в <a class="ref" href="static-pages#fig:hello_world">Рис.&nbsp;3.3</a> это, всего лишь, содержимое <code>title</code> тега&nbsp;&mdash;&nbsp;&ldquo;Greeting&rdquo;.</p>

<div class="label" id="fig:hello_world"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/hello_world.png" alt="hello_world" /></span></div><div class="caption"><span class="header">Рисунок  3.3: </span><span class="description">Наш собственный статичный HTML файл (<a href="http://localhost:3000/hello.html"><tt>http://localhost:3000/hello.html</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/hello_world-full.png">(полный размер)</a></span></div></div>


<p>Так как этот файл только для демонстрационных целей, и, в действительности, мы не хотим, чтобы он стал частью нашего примера приложения, лучше удалить его:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm public/hello.html
</pre></div>
</div>


<p>Пока мы оставим <code>index.html</code> файл, но, конечно, в конечном итоге мы удалим и его: мы ведь не хотим, чтобы главной страницей нашего приложения была дефолтная страница Rails показанная на <a class="ref" href="beginning#fig:riding_rails_3">Рис.&nbsp;1.3</a>. В <a class="ref" href="filling-in-the-layout#sec:layout_links">Разделе&nbsp;5.2</a> мы увидим, что нужно изменить, чтобы адрес <a href="http://localhost:3000/"><tt>http://localhost:3000/</tt></a> указывал на нечто иное, нежели <code>public/index.html</code>.</p>

<div class="label" id="sec:static_pages_with_rails"></div>


<h3><a id="sec:3.1.2" href="static-pages#sec:static_pages_with_rails" class="heading"><span class="number">3.1.2</span> Статические страницы с Rails</a></h3>


<p>Возможность возвращать (показывать) статические HTML файлы это хорошо, но это не особенно полезно для создания динамических веб-приложений. В этом разделе мы сделаем первый шаг на пути создания динамических страниц, создав несколько Rails <em>действий</em>, которые являются более мощным средством для определения URL(-ов), нежели статические файлы.<sup class="footnote" id="fnref:3.5"><a href="#fn:3.5">5</a></sup> Rails действия взаимосвязаны внутри <em>контроллера (Controller)</em> (C в MVC из  <a class="ref" href="beginning#sec:mvc">Раздела&nbsp;1.2.6</a>), который содержит ряд actions (действий), связанных общей целью. Мы получили представление о контроллерах в <a class="ref" href="a-demo-app#top">Главе&nbsp;2</a>, и придем к еще более глубокому пониманию их когда изучим <a href="http://ru.wikipedia.org/wiki/REST">REST архитектуру</a> более полно (начиная с <a class="ref" href="modeling-and-viewing-users-one#top">Главы&nbsp;6</a>); в сущности, контроллер это контейнер для группы (возможно, динамических) веб-страниц.</p>

<p>Для начала вспомним из <a class="ref" href="beginning#sec:git_commands">Раздела&nbsp;1.3.5</a> что при использовании Git, хорошо бы делать нашу работу в ветке (ответвлении) (branch) с отдельной темой, а не в мастер ветке. Если вы используете Git для управления версиями, вы должны выполнить следующую команду:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b static-pages
</pre></div>
</div>


<p>Rails поставляется со скриптом для создания контроллеров называемым <code>generate</code>; имя контроллера это все, что ему (скрипту) нужно для его магической работы. Так как мы делаем этот контроллер для обработки (в основном) статичных страниц, мы просто назовем его Pages контроллер, и запланируем сделать actions (действия) для Home, Contact и About страниц. <code>Generate</code> скрипт принимает, дополнительно, перечень действий, поэтому мы включим некоторые из наших первоначальных действий непосредственно в командную строку:</p>

<div class="label" id="code:generating_pages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.4.</span> <span class="description">Генерация Pages контроллера.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Pages home contact
<span class="go">      create  app/controllers/pages_controller.rb</span>
<span class="go">       route  get &quot;pages/contact&quot;</span>
<span class="go">       route  get &quot;pages/home&quot;</span>
<span class="go">      invoke  erb</span>
<span class="go">      create    app/views/pages</span>
<span class="go">      create    app/views/pages/home.html.erb</span>
<span class="go">      create    app/views/pages/contact.html.erb</span>
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/controllers/pages_controller_spec.rb</span>
<span class="go">      create    spec/views/pages</span>
<span class="go">      create    spec/views/pages/home.html.erb_spec.rb</span>
<span class="go">      create    spec/views/pages/contact.html.erb_spec.rb</span>
<span class="go">      invoke  helper</span>
<span class="go">      create    app/helpers/pages_helper.rb</span>
<span class="go">      invoke    rspec</span>
</pre></div>
</div></div>


<p>(Отметим, что из-за установки RSpec посредством <code>rails generate rspec:install</code>, генерация контроллера автоматически создает RSpec test файлы в <code>spec/</code> директории). Здесь я намеренно &ldquo;забыл&rdquo; <code>about</code> страницу, так что мы сможем увидеть, как добавить ее вручную (<a class="ref" href="static-pages#sec:first_tests">Раздел&nbsp;3.2</a>).</p>

<p>Pages контроллер, сгенерированный в <a class="ref" href="static-pages#code:generating_pages">Листинге&nbsp;3.4</a> автоматически обновляет <em>routes</em> файл, из каталога <code>config/routes.rb</code>, который Rails использует для определения соответствий между URL и веб страницами. Tак как это наше первое знакомство с <code>config</code> директорией, полезно взглянуть на нее (<a class="ref" href="static-pages#fig:config_directory_rails_3">Рис.&nbsp;3.4</a>). <code>Сonfig</code>&nbsp;&mdash;&nbsp;директория где Rails хранит файлы, необходимые для <em>конфиг</em>урации приложения&nbsp;&mdash;&nbsp;отсюда и название.</p>

<div class="label" id="fig:config_directory_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/config_directory_rails_3.png" alt="config_directory_rails_3" /></span></div><div class="caption"><span class="header">Рисунок  3.4: </span><span class="description">Содержимое <code>config</code> директории примера приложения.&nbsp;<a href="http://railstutorial.org/images/figures/config_directory_rails_3-full.png">(полный размер)</a></span></div></div>


<p>Так как мы сгенерировали <code>home</code> и <code>contact</code> действия, routes файл уже имеет правила для каждого из них, что видно в  <a class="ref" href="static-pages#code:pages_routes">Листинге&nbsp;3.5</a>.</p>

<div class="label" id="code:pages_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.5.</span> <span class="description">Маршруты для <code>home</code> и <code>contact</code> действий контроллера Pages.<br /> <code>config/routes.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;pages/contact&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Здесь правило</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;pages/home&quot;</span>
</pre></div>
</div>


<p>направляет запрос URL <tt>/pages/home</tt> в <code>home</code> действие Pages контроллера. Более того, используя <code>get</code> мы приговариваем маршрут отвечать на <tt>GET</tt> запрос, который является одним из фундаментальных <em>HTTP глаголов</em> поддерживаемых протоколом передачи гипертекста  (<a class="ref" href="static-pages#sidebar:get_etc">Блок&nbsp;3.1</a>). В нашем случае это значит, что когда мы сгенерировали <code>home</code> действие внутри контроллера Pages мы автоматически получили страницу по адресу <tt>/pages/home</tt>. Чтобы увидеть результаты, убейте сервер, нажав Ctrl-C, запустите <code>rails server</code>, а затем перейдите на <a href="http://localhost:3000/pages/home"><tt>/pages/home</tt></a> (<a class="ref" href="static-pages#fig:raw_home_view">Рис.&nbsp;3.5</a>).</p>

<div class="label" id="fig:raw_home_view"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/raw_home_view.png" alt="raw_home_view" /></span></div><div class="caption"><span class="header">Рисунок  3.5: </span><span class="description">Cырое home представление (<a href="http://localhost:3000/pages/home"><tt>/pages/home</tt></a>) сгенерированное Rails.&nbsp;<a href="http://railstutorial.org/images/figures/raw_home_view-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sidebar:get_etc"></div>


<div class="sidebar"><span class="title"><span class="header">Блок 3.1.</span><span class="description"><tt>GET</tt>, et cet.</span></span>
<p>HyperText Transfer Protocol ("протокол  передачи  гипертекста")  (<a   href="http://ru.wikipedia.org/wiki/HTTP#.D0.9C.D0.B5.D1.82.D0.BE.D0.B4.D1.8B">HTTP</a>) определяет четыре основных операции, соответствующие четырем глаголам <em>GET</em><em> (получить)</em><em>, POST</em><em> (отправить)</em><em>,</em> PUT (поместить), и DELETE (удалить)<em>.</em> Они относятся к операциям между <em>клиентским</em> компьютером (как правило, работает веб-браузер, например Firefox или Safari) и <em>сервером</em> (как правило, работает веб-сервер, такой как Apache или Nginx). (Важно понимать, что при разработке Rails приложения на локальном компьютере, клиент и сервер на одной физической машине, но в целом они разные.) Акцент на глаголы HTTP является типичным для фреймворков (веб-платформ) (включая Rails), находящихся под влиянием <em>REST архитектуры,</em> (ее основы рассматриваются в <a class="ref" href="a-demo-app#top">Главе&nbsp;2</a> и более подробно в <a class="ref" href="sign-up#top">Главе&nbsp;8</a>).</p>

<p><tt>GET</tt> является самой распространенной операцией HTTP, используемой для <em>чтения</em> данных в Интернете; это просто означает "получить страницу", и каждый раз, когда вы посещаете сайт, такой как google.com или craigslist.org браузер передает запрос <tt>GET</tt>.<br/> <tt>POST </tt>это следующая наиболее распространенная операция, это запрос, передаваемый вашим браузером при предоставлении (заполнении) формы. В Rails приложениях, <tt>POST</tt> запросы обычно используются для <em>создания</em> вещи (хотя HTTP позволяет <tt>POST</tt> также выполнять обновления), например, запрос <tt>POST</tt> отправляется, когда вы представляете регистрационную форму, создаете нового пользователя на удаленном сайте.<br/> Два других глагола, <tt>PUT</tt> и <tt>DELETE,</tt> предназначены для <em>обновления</em> и <em>уничтожения</em> вещей на удаленном сервере. Эти запросы встречаются реже, чем <tt>GET</tt> и <tt>POST</tt> поскольку браузеры не в состоянии отправить их в естественном виде.</p>
</div>


<p>Чтобы понять, откуда появилась эта страница, для начала посмотрите на контроллер Pages в текстовом редакторе, вы должны увидеть что-то вроде <a class="ref" href="static-pages#code:pages_controller">Листинга&nbsp;3.6</a>. (Вы можете отметить, что, в отличие от демо контроллеров Users и Microposts из <a class="ref" href="a-demo-app#top">Главы&nbsp;2</a>, контроллер Pages не следует REST конвенции.)</p>

<div class="label" id="code:pages_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.6.</span> <span class="description">Контроллер Pages сделанный в <a class="ref" href="static-pages#code:generating_pages">Листинге&nbsp;3.4</a>. <br /> <code>app/controllers/pages_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Мы видим здесь, что <code>pages_controller.rb</code> определяет <em>класс</em> называемый <code>PagesController</code>. Классы это просто удобный способ организовать <em>функции</em> (также называемые <em>методами</em>), такие как <code>home</code> и <code>contact</code> действия, которые определяются с помощью ключевого слова <code>def</code>. Угловая скобка&nbsp;<code>&lt;</code> указывает, что <code>PagesController</code> <em>наследует</em> от Rails класса <code>ApplicationController</code>; как мы увидим через мгновение, это означает, что наши страницы оснащены большим количеством Rails-определенных функций. (Мы узнаем больше об этих двух классах и наследовании в <a class="ref" href="rails-flavored-ruby#sec:ruby_classes">Разделе&nbsp;4.4</a>.)</p>

<p>В случае с контроллером Pages, оба его метода изначально пусты:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">home</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">contact</span>
<span class="k">end</span>
</pre></div>
</div>


<p>В переводе на простой Ruby, эти методы просто ничего не делают. В Rails, ситуация иная; <code>PagesController</code> это класс Ruby, а потому, он наследует от <code>ApplicationController</code> поведение его методов, специфичное для Rails: при посещении URL <tt>/pages/home</tt>, Rails смотрит в контроллер Pages и выполняет код в <code>home</code>, а затем визуализирует <em>представление</em> (<em>view</em>) (V в MVC из <a class="ref" href="beginning#sec:mvc">Раздела&nbsp;1.2.6</a>) соответствующее действию. В данном случае, <code>home</code> действие пустое, так что все посещения <tt>/pages/home</tt> просто визуализируют представления. Итак, как же выглядит представление, и как мы можем его найти?</p>

<p>Если вы еще раз посмотрите на <a class="ref" href="static-pages#code:generating_pages">Листинг&nbsp;3.4</a>, вы можете найти соответствие между действиями и представлениями: действие, такое как <code>home</code> имеет соответствующее представление <code>home.html.erb</code>. Мы узнаем в <a class="ref" href="static-pages#sec:slightly_dynamic_pages">Разделе&nbsp;3.3</a> что означает <code>.erb</code> часть расширения; <code>.html</code> часть расширения подсказывает, что представление, в основном, выглядит как HTML  (<a class="ref" href="static-pages#code:raw_home_view">Листинг&nbsp;3.7</a>).</p>

<div class="label" id="code:raw_home_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.7.</span> <span class="description">Сгенерированное представление для страницы Home. <br /> <code>app/views/pages/home.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Pages#home<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/pages/home.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Представление для <code>contact</code> действия выглядит аналогично (<a class="ref" href="static-pages#code:raw_contact_view">Листинг&nbsp;3.8</a>).</p>

<div class="label" id="code:raw_contact_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.8.</span> <span class="description">Сгенерированное представление для страницы Contact. <br /> <code>app/views/pages/contact.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Pages#contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/pages/contact.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Оба эти представления&nbsp;&mdash;&nbsp;лишь заглушки: у них есть заголовок (внутри  <code>h1</code> тега) и абзац (<code>p</code> тег) с указанием полного пути к соответствующему файлу. Мы добавим немного (очень немного) динамического контента, начиная с <a class="ref" href="static-pages#sec:slightly_dynamic_pages">Раздела&nbsp;3.3</a>, но пока они статичны, эти представления подчеркивают важный момент: Rails представления могут просто содержать статический HTML. Что касается браузера, то, чистые HTML файлы из  <a class="ref" href="static-pages#sec:truly_static_pages">Раздела&nbsp;3.1.1</a> и контроллер / действие метод доставки страниц неразличимы: все, что видит браузер, это HTML.</p>

<p>В оставшейся части этой главы, мы сначала добавим <code>about</code> действие, которое мы &ldquo;забыли&rdquo; в <a class="ref" href="static-pages#sec:static_pages_with_rails">Разделе&nbsp;3.1.2</a>, добавим очень небольшое количество динамического содержимого, а затем сделаем первые шаги в сторону дизайна страниц с CSS. Прежде чем двигаться дальше, если вы используете Git , хорошая идея, добавить сейчас файлы для контроллера Pages в репозиторий:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Added a Pages controller&quot;</span>
</pre></div>
</div>




<div class="label" id="sec:first_tests"></div>


<h2><a id="sec:3.2" href="static-pages#sec:first_tests" class="heading"><span class="number">3.2</span> Наши первые тесты</a></h2>


<p>Если вы спросите пять Rails разработчиков о том, как проверить любой кусок кода, вы получите около пятнадцати разных ответов, но все они согласятся с тем, что вам обязательно надо писать тесты. Именно в этом духе мы будем подходить к тестированию нашего примера приложения - непрерывно писать тесты, не слишком тревожась о том, чтобы сделать их идеальными. Вы не должны принимать тесты в <em>Rails Учебнике</em> как Евангелие, они основаны на стиле, который я выработал во время моей работы и чтения чужого кода. По мере приобретения опыта, как разработчика Rails, вы, несомненно, сформируете ваши собственные предпочтения и разовьете свой собственный стиль тестирования.</p>

<p>В дополнение к написанию тестов на всех этапах разработки примера приложения, мы также все чаще будем делать выбор о том, <em>когда</em> писать тесты, в пользу написания их,  <em>до</em> кода приложения&nbsp;&mdash;&nbsp;подход, известный как <em>test-driven development</em>, или TDD (разработка через тестирование).<sup class="footnote" id="fnref:3.6"><a href="#fn:3.6">6</a></sup> Нашим конкретным заданием будет добавление страницы About к нашему примеру сайта. К счастью, добавить дополнительную страницу не сложно и вы, может быть, даже в состоянии угадать ответ, основываясь на примерах в предыдущем разделе, а это значит, что мы можем сосредоточиться на тестировании, в котором содержится довольно много новых идей.</p>

<p>Во-первых, тестирование на существование страницы может показаться излишним, но опыт показывает, что это не так. Так много вещей может пойти не так при написании программного обеспечения, что, хороший набор тестов имеет неоценимое значение для обеспечения качества. Кроме того, постоянное расширение - обычное явление для компьютерных программ и особенно веб-приложений, и, внося изменения, вы каждый раз рискуете внести ошибки. Написание тестов не гарантирует, что этих ошибок не будет, но это даст вам гораздо больше шансов поймать (и исправить) их. Кроме того, написание тестов для ошибок, которые <em>уже</em> случились, делает гораздо менее вероятным их повторное появление.</p>

<p>(Как отмечалось в  <a class="ref" href="beginning#sec:comments_for_various_readers">Разделе&nbsp;1.1.1</a>, если вы найдете тесты подавляющими, двигайтесь вперед и пропустите их в первом чтении. Когда у вас будет более сильное понимание Rails и Ruby, вы сможете вернуться назад и изучить тестирование на втором подходе.)</p>

<div class="label" id="sec:testing_tools"></div>


<h3><a id="sec:3.2.1" href="static-pages#sec:testing_tools" class="heading"><span class="number">3.2.1</span> Инструменты тестирования.</a></h3>


<p>Нашим основным инструментом при написании тестов будет фреймворк (платформа) <a href="http://rspec.info/">RSpec</a>, который представляет из себя <a  rel="nofollow" href="http://ru.wikipedia.org/wiki/Предметно-ориентированный_язык_программирования"><em>предметно-ориентированный язык</em></a> для описания поведения кода, совмещенный вместе с программой (так называемой <code>rspec</code>) для проверки желаемого поведения. Предназначенный для тестирования любой Ruby-программы, RSpec получил значительную поддержку в сообществе Rails. Оби Фернандес, автор <a href="http://www.amazon.com/gp/product/0321601661?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0321601661"><em>The Rails&nbsp;3 Way</em></a>, назвал RSpec &ldquo;the Rails Way&rdquo;, и я согласен с ним.<sup class="footnote" id="fnref:3.7"><a href="#fn:3.7">7</a></sup></p>

<p>Если вы следовали инструкциям во введении к этой главе, RSpec уже установлен Bundler-ом (<a class="ref" href="static-pages#code:gemfile_rspec">Листинг&nbsp;3.1</a>).</p>

<div class="label" id="sec:autotest"></div>


<h4><a id="sec:3.2.1.1" href="static-pages#sec:autotest" class="heading">Autotest</a></h4>


<p>Автотест это инструмент, который непрерывно запускает ваш набор тестов в фоновом режиме, опираясь на специальный файл, для изменений, которые вы делаете. Например если вы измените файл контроллера, Autotest запустит тест для этого контроллера. Результатом служит мгновенная обратная связь о ходе тестов. Мы узнаем больше об Autotest, когда увидим его в действии (<a class="ref" href="static-pages#sec:TDD">Раздел&nbsp;3.2.2</a>).</p>

<p>Установка Autotest необязательна, и его конфигурирование немного мудреное, но если вы заставите его работать на вaшей системе, я уверен, вы оцените его полезность, как и я. Для установки Autotest, установите <tt>autotest</tt> и <tt>autotest-rails-pure</tt><sup class="footnote" id="fnref:3.8"><a href="#fn:3.8">8</a></sup> гемы следующим образом:<sup class="footnote" id="fnref:3.9"><a href="#fn:3.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="o">[</span>sudo<span class="o">]</span> gem install autotest -v 4.4.6
<span class="gp">$</span> <span class="o">[</span>sudo<span class="o">]</span> gem install autotest-rails-pure -v 4.1.2
</pre></div>
</div>


<p>Следующие шаги зависят от вашей платформы. Я пойду шагами для OS X, так как это то, что я использую, а затем дам ссылки на сообщения в блоге, где обсуждается Autotest на Linux и Windows. На OS X, вы должны <a href="http://growl.info/">установить Growl</a> (если у вас его еще нет), а затем установить гемы <tt>autotest-fsevent</tt> и <tt>autotest-growl</tt>:<sup class="footnote" id="fnref:3.10"><a href="#fn:3.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="o">[</span>sudo<span class="o">]</span> gem install autotest-fsevent -v 0.2.4
<span class="gp">$</span> <span class="o">[</span>sudo<span class="o">]</span> gem install autotest-growl -v 0.2.9
</pre></div>
</div>


<p>Если FSEvent не установился должным образом, перепроверьте, что <a href="http://developer.apple.com/technologies/tools/xcode.html">Xcode</a> установлен на вашей системе.</p>

<p>Затем создайте конфигурационный файл Autotest в корневом каталоге Rails и заполните его содержанием из <a class="ref" href="static-pages#code:dot_autotest">Листинга&nbsp;3.9</a> (или <a class="ref" href="static-pages#code:dot_autotest_alt">Листинга&nbsp;3.10</a> если <a class="ref" href="static-pages#code:dot_autotest">Листинг&nbsp;3.9</a> выдает ошибку на вашей системе):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mate .autotest
</pre></div>
</div>


<div class="label" id="code:dot_autotest"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.9.</span> <span class="description">Конфигурационный <code>.autotest</code> файл для Autotest на OS&nbsp;X.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;autotest/growl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;autotest/fsevent&#39;</span>
</pre></div>
</div></div>




<div class="label" id="code:dot_autotest_alt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.10.</span> <span class="description">Альтернативный <code>.autotest</code> файл необходимый на некоторых системах.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;autotest-growl&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;autotest-fsevent&#39;</span>
</pre></div>
</div></div>


<p>(Примечание: это создаст конфигурацию Autotest только для примера приложения, если вы хотите сделать эту конфигурацию Autotest доступной для других Rails или Ruby проектов, вы должны создать <code>.autotest</code> файл в вашем <em>home</em> используя вместо предыдущей команды следующую :</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> mate ~/.autotest
</pre></div>
</div>


<p>где <tt class="verb">~</tt> (тильда) является Unix символом для &ldquo;home каталога&rdquo;.)</p>

<p>Если вы работаете в Linux с рабочим столом Gnome, вы должны попробовать шаги на <a href="http://automate-everything.com/2009/08/gnome-and-autospec-notifications/">Automate Everything</a>, которые настраивают в Linux систему, подобную Growl уведомлениям на OS&nbsp;X. Windows пользователи должны попробовать установить <a href="http://www.growlforwindows.com/gfw/">Growl for Windows</a>, а затем следовать инструкциям на <a href="http://github.com/svoop/autotest-growl">GitHub странице <code>autotest-growl</code></a>. Linux и Windows пользователи могут пожелать взглянуть на <a href="http://github.com/carlosbrando/autotest-notification">autotest-notification</a>; которую читатель  <em>Rails Tutorial</em> Fred Schoeneman описал в <a href="http://fredschoeneman.posterous.com/pimp-your-autotest-notification">своем блоге</a>.<sup class="footnote" id="fnref:3.11"><a href="#fn:3.11">11</a></sup></p>

<div class="label" id="sec:TDD"></div>


<h3><a id="sec:3.2.2" href="static-pages#sec:TDD" class="heading"><span class="number">3.2.2</span> TDD: Красный, Зеленый, Refactor (реорганизация)</a></h3>


<p>В Test-Driven Development, мы вначале пишем <em>провальный</em> тест: в нашем случае, кусок кода, который выражает идею, что  &ldquo;должна быть <code>about</code>&rdquo; страница. Затем мы заставим тест пройти, в нашем случае, добавив <code>about</code> действие и соответствующее представление. Причина, по которой мы обычно не делаем наоборот&nbsp;—&nbsp;вначале реализация, а затем тест, в том, что таким образом мы убеждаемся, что мы на самом деле тестируем функцию, которую добавляем. Прежде чем я начал использовать TDD, я был поражен, узнав как часто мои "тесты" на самом деле тестировали не то, или даже вообще ничего не тестировали. Убедившись, что вначале тест не пройден, а затем проходит, мы можем быть более уверенными в том, что тест делает правильные вещи.</p>

<p>Важно понимать, что TDD — не всегда правильный инструмент для работы. В частности, когда вы не полностью уверены в том, как решить данную проблему программирования, часто бывает полезным пропустить тесты и писать только код приложения, просто чтобы получить представление о том, как решение будет выглядеть. (На  языке <a   href="http://ru.wikipedia.org/wiki/Экстремальное_программирование">Экстремального Программирования (XP)</a>, этот поисковый этап называется<a   href="http://lingvo.yandex.ru/spike/"> <em>spike</em></a>.) Как только вы увидите общую форму решения, вы сможете использовать TDD для реализации более изысканной версии.</p>

<p>Один из способов работы в test-driven development это цикл, известный как &ldquo;Красный, Зеленый, Рефакторинг (Реорганизация)&rdquo;. Первый шаг, Красный, относится к написанию провального теста, который многие инструменты тестирования обозначают красным цветом. Следующий шаг, Зеленый, относится к проходящим тестам, обозначаемым зеленым (ждать его) цветом. После того как наши тесты (или набор тестов) прошли, мы свободны <em>реорганизовывать</em> наш код, изменяя его форму (устраняя дублирование, например) без изменения функции.</p>

<p>У нас еще нет никаких цветов, так что давайте начнем с Красного. В первый раз RSpec (и тестирование в целом) может быть немного пугающим, поэтому мы будем использовать тесты, сгенерированные <code>rails generate controller Pages</code> в  <a class="ref" href="static-pages#code:generating_pages">Листинге&nbsp;3.4</a> для раскачки. Так как я не пристрастен к отдельным тестам для представлений или хелперов, которые я нахожу весьма хрупкими наш первый шаг это их удаление. Если вы используете Git, вы можете сделать это следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git rm -r spec/views
<span class="gp">$</span> git rm -r spec/helpers
</pre></div>
</div>


<p>Или без Git:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm -rf spec/views
<span class="gp">$</span> rm -rf spec/helpers
</pre></div>
</div>


<p>Мы сделаем тесты для представлений и хелперов непосредственно в контроллере теста, в <a class="ref" href="static-pages#sec:slightly_dynamic_pages">Разделе&nbsp;3.3</a>.</p>

<p>Для начала работы с RSpec, взглянем на Pages контроллер spec<sup class="footnote" id="fnref:3.12"><a href="#fn:3.12">12</a></sup> который мы только что сгенерировали (<a class="ref" href="static-pages#code:default_pages_controller_spec">Листинг&nbsp;3.11</a>).</p>

<div class="label" id="code:default_pages_controller_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.11.</span> <span class="description">Сгенерированный Pages контроллер spec. <br /> <code>spec/controllers/pages_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;contact&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Этот код является чистым Ruby, но даже если вы изучали Ruby прежде, он, вероятно, выглядит не очень знакомым. Это происходит потому, что RSpec использует общую гибкость Ruby для определения <em>предметно-ориентированного языка</em> (DSL) созданного только для тестирования. Важным моментом является то, что <em>вам не нужно понимать синтаксис RSpec, чтобы иметь возможность использовать RSpec</em>. На первый взгляд это может показаться магией, но RSpec разработан так, чтобы быть более или менее похожим на английский, и если вы следуете примерам <code>generate</code> сценариев и другим примерам в этом учебнике вы разберетесь с ним довольно быстро.</p>

<p><a class="ref" href="static-pages#code:default_pages_controller_spec">Листинг&nbsp;3.11</a> содержит два <code>описывающих</code> блока, каждый с одним <em>примером</em> (т.е., блок начинается с  <code>it "&hellip;" do</code>). давайте сфокусируемся на первом, чтобы почувствовать, что он делает:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>Первая строка указывает на то, что мы описываем (describing) <tt>GET</tt> операцию для <code>home</code> действия. Это всего лишь описание, и это может быть все, что угодно; для RSpec это не важно, но, вероятно, важно для вас и других читателей. В данном случае, <code>"GET &rsquo;home&rsquo;"</code> указывает, что тест соответствует HTTP запросу <tt>GET</tt>, как обсуждалось в <a class="ref" href="static-pages#sidebar:get_etc">Блоке&nbsp;3.1</a>. Затем spec говорит что когда вы посещаете home страницу, она должна быть успешной. Как и в первой строке, то, что происходит внутри кавычек не имеет отношения к RSpec, и предназначено для наглядности. Третья строка, <code>get &rsquo;home&rsquo;</code>, это первая строка, которая действительно что-то делает. Внутри RSpec, эта строка <em>на самом деле представляет запрос GET</em>; другими словами, он действует как браузер и попадает на страницу, в данном случае <tt>/pages/home</tt>. (Он автоматически знает что нужно обратиться к контроллеру Pages, потому что это тест Pages контроллера; знает, что нужно попасть на home страницу, потому что мы сказали ему это явно.), наконец, четвертая строка говорит, что <em>ответ</em> нашего приложения должен указывать на успех (т.е. он должен возвращать <em>код статуса</em>  <tt>200</tt>; см. <a class="ref" href="static-pages#sidebar:response_codes">Блок&nbsp;3.2</a>).</p>

<div class="label" id="sidebar:response_codes"></div>


<div class="sidebar"><span class="title"><span class="header">Блок 3.2.</span><span class="description">Коды ответа HTTP.</span></span>
<p>После того как клиент (такой как веб браузер) посылает запрос соответствующий одному из глаголов HTTP (<a class="ref" href="static-pages#sidebar:get_etc">Блок&nbsp;3.1</a>), сервер <em>отвечает</em> цифровым кодом указывающим на <a   href="http://ru.wikipedia.org/wiki/Список_кодов_состояния_HTTP">HTTP статус</a> ответа. Например, код статуса <tt>200</tt> значит &ldquo;успех&rdquo;, а код статуса 301 означает &ldquo;постоянная переадресация&rdquo;. Если вы <a  href="http://www.google.com/search?q=install+curl">установите <tt>curl</tt></a>, клиент командной строки, который может выдавать HTTP-запросы, вы сможете видеть их непосредственно, например, <tt>www.google.com</tt> (где <tt class="verb">--head</tt> флаг не позволяет <code>curl</code> возвращать всю страницу):</p>

<pre class="verbatim">  $ curl --head www.google.com
  HTTP/1.1 200 OK
  .
  .
  .</pre>


<p>Здесь Google указывает, что запрос был успешным, возвращая статус <tt>200&nbsp;OK</tt>. В отличие от, постоянно перенаправляющего <tt>google.com</tt> (на <tt>www.google.com</tt>,  естественно), который указывает код статуса  <tt>301</tt> (a &ldquo;<tt>301</tt> redirect&rdquo;):</p>

<pre class="verbatim">  $ curl --head google.com
  HTTP/1.1 301 Moved Permanently
  Location: http://www.google.com/
  .
  .
  .</pre>


<p>(<em>Примечание:</em> Приведенные выше результаты могут варьироваться в зависимости от страны.)</p>

<p>Когда мы пишем <code>response.should be_success</code> в тесте RSpec, RSpec проверяет, что ответом нашего приложения на запрос является код статуса&nbsp;<tt>200</tt>.</p>
</div>


<p>Теперь пришло время запустить тест. Есть несколько различных, в основном эквивалентных, способов сделать это.<sup class="footnote" id="fnref:3.13"><a href="#fn:3.13">13</a></sup> Одним из способов для выполнения всех тестов является использование <code>rspec</code> сценария в командной строке следующим образом:<sup class="footnote" id="fnref:3.14"><a href="#fn:3.14">14</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
<span class="go">....</span>

<span class="go">Finished in 0.07252 seconds</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>(К сожалению, множество вещей могут пойти не так в этой точке. Если набор тестов не проходит, попробуйте мигрировать базу данных с <code>bundle exec rake db:migrate</code> как описано в <a class="ref" href="a-demo-app#sec:demo_users_resource">Разделе&nbsp;2.2</a>. Если RSpec вообще не работает, попробуйте удалить и переустановить его:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> gem uninstall rspec rspec-rails
<span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Если он все же не заработал, и если вы используете <a href="http://rvm.beginrescueend.com/">RVM</a>, попробуйте удалить Rails Tutorial gemset и переустановить гемы:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rvm gemset delete rails3tutorial
<span class="gp">$</span> rvm --create use 1.9.2@rails3tutorial
<span class="gp">$</span> rvm --default 1.9.2@rails3tutorial
<span class="gp">$</span> gem install rails -v 3.0.9
<span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Даже если он все еще не работает, мои идеи кончились.)</p>

<p>Когда мы запускаем <code>bundle exec rspec spec/</code>, <code>rspec</code> является программой, предоставляемой RSpec, в то время как <code>spec/</code> это <em>директория</em> , в которой вы хотите запустить specs. Вы также можете запустить specs только в конкретном подкаталоге. Например, эта команда выполняет только specs контроллера:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/controllers/
<span class="go">....</span>
<span class="go">Finished in 0.07502 seconds</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>Вы также можете запустить один файл:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/controllers/pages_controller_spec.rb
<span class="go">....</span>
<span class="go">Finished in 0.07253 seconds</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>Отметьте, что, как и в <a class="ref" href="a-demo-app#sec:demo_users_resource">Разделе&nbsp;2.2</a>, мы использовали <code>bundle exec</code> чтобы использовать исполняемый файл (в данном случае, <code>rspec</code>), соответствующий гемам в  <code>Gemfile</code> нашего приложения. Поскольку данная конструкция достаточно многословна, Bundler позволяет создание связанных бинарников следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install --binstubs
</pre></div>
</div>


<p>Что создает все необходимые файлы в <code>bin/</code> директории приложения, таким образом мы теперь можем запустить наш набор тестов следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rspec spec/
</pre></div>
</div>


<p>Аналогично для <code>rake</code>, и т.д.:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bin/rake db:migrate
</pre></div>
</div>


<p>Ради читателей, пропустивших этот раздел, остальная часть этого учебника будет ошибаться в сторону осторожности и явного использования <code>bundle exec</code>, но, конечно же, вы вполне можете использовать эту, более компактную, версию.</p>

<p>Результат всех трех команд, о которых мы говорили выше, одинаков, поскольку Pages controller spec в настоящее время наш единственный тест. В остальной части книги я обычно буду опускать результат выполнения тестов, но вам следует запускать <code>bundle exec rspec spec/</code> (или один из вариантов этой команды) регулярно, или, еще лучше, используйте Autotest для автоматического запуска набора тестов. Говоря о котором…</p>

<p>Если у вас установлен Autotest, вы можете запустить его на своих Rspec тестах следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> autotest
</pre></div>
</div>


<p>Если вы используете Mac с включенными уведомлениями Growl, вы, должно быть, в состоянии повторить мои установки, показанные на <a class="ref" href="static-pages#fig:autotest_green">Рис.&nbsp;3.6</a>. С Autotestом работающем в фоновом режиме и Growl уведомлениями, говорящими вам о состоянии ваших тестов, TDD может вызывать сильное привыкание.</p>

<div class="label" id="fig:autotest_green"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_green.png" alt="autotest_green" /></span></div><div class="caption"><span class="header">Рисунок  3.6: </span><span class="description">Autotest (через <code>autotest</code>) в действии, с уведомлением Growl.&nbsp;<a href="http://railstutorial.org/images/figures/autotest_green-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:spork"></div>


<h4><a id="sec:3.2.2.1" href="static-pages#sec:spork" class="heading">Spork</a></h4>


<p>Вы, возможно, заметили, что издержки при запуске комплекта тестов, могут быть значительными. Это происходит потому что каждый раз, когда RSpec запускает тесты, он должен перезагрузить всю среду Rails. <a href="http://github.com/timcharper/spork">Spork test server</a><sup class="footnote" id="fnref:3.15"><a href="#fn:3.15">15</a></sup> предназначен для решения этой проблемы. Spork загружает среду <em>один раз</em>, и затем поддерживает пул процессов для запуска будущих тестов. Spork особенно полезен в комбинации с Автотестом.</p>

<p>Конфигурирование и запуск Spork может быть трудным, и это скорее факультативная тема. <strong>Если вы застрянете, пожалуйста пропустите пока этот Раздел.</strong></p>

<p>Первый шаг должен добавить <tt>spork</tt> гем зависимость в <code>Gemfile</code> (<a class="ref" href="static-pages#code:gemfile_spork">Листинг&nbsp;3.12</a>).</p>

<div class="label" id="code:gemfile_spork"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.12.</span> <span class="description"><code>Gemfile</code> для sample app.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.9&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.3&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.6.1&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.0.rc8&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Потом установите его:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Затем идет загрузка конфигурации Spork:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork --bootstrap
</pre></div>
</div>


<p>Теперь нам необходимо отредактировать конфигурационный файл RSpec, <code>spec/spec_helper.rb</code>, так, чтобы окружение было загружено в блоке <em>prefork</em> который принимает меры, чтобы оно было загружено только однажды (<a class="ref" href="static-pages#code:spork_spec_helper">Листинг&nbsp;3.13</a>). <em>Примечание: </em>Используйте этот код, только вместе со Spork. Если вы попробуете использовать <a class="ref" href="static-pages#code:spork_spec_helper">Листинг&nbsp;3.13</a> без Spork, набор тестов вашего приложения не запустится.</p>

<div class="label" id="code:spork_spec_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.13.</span> <span class="description">Добавление загрузки окружения в блок <code>Spork.prefork</code>. <br /> <code>spec/spec_helper.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spork&#39;</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">prefork</span> <span class="k">do</span>
  <span class="c1"># Loading more in this block will cause your tests to run faster. However, </span>
  <span class="c1"># if you change any configuration or code from libraries loaded here, you&#39;ll</span>
  <span class="c1"># need to restart spork for it take effect.</span>
  <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;RAILS_ENV&quot;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;test&#39;</span>
  <span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s2">&quot;../../config/environment&quot;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
  <span class="nb">require</span> <span class="s1">&#39;rspec/rails&#39;</span>

  <span class="c1"># Requires supporting files with custom matchers and macros, etc,</span>
  <span class="c1"># in ./support/ and its subdirectories.</span>
  <span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;spec/support/**/*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>

  <span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="c1"># == Mock Framework</span>
    <span class="c1">#</span>
    <span class="c1"># If you prefer to use mocha, flexmock or RR, uncomment the appropriate line:</span>
    <span class="c1">#</span>
    <span class="c1"># config.mock_with :mocha</span>
    <span class="c1"># config.mock_with :flexmock</span>
    <span class="c1"># config.mock_with :rr</span>
    <span class="n">config</span><span class="o">.</span><span class="n">mock_with</span> <span class="ss">:rspec</span>

    <span class="n">config</span><span class="o">.</span><span class="n">fixture_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="o">::</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/spec/fixtures&quot;</span>

    <span class="c1"># If you&#39;re not using ActiveRecord, or you&#39;d prefer not to run each of your</span>
    <span class="c1"># examples within a transaction, comment the following line or assign false</span>
    <span class="c1"># instead of true.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">use_transactional_fixtures</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Spork</span><span class="o">.</span><span class="n">each_run</span> <span class="k">do</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Прежде, чем запустить Spork, мы можем получить базовое значение для издержек тестирования, сделав тайминг для нашего набора тестов следующим образом:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>rspec spec/
<span class="go">..</span>


<span class="go">Finished in 0.09606 seconds</span>
<span class="go">2 examples, 0 failures</span>

<span class="go">real    0m7.445s</span>
<span class="go">user    0m5.248s</span>
<span class="go">sys     0m1.475s</span>
</pre></div>
</div>


<p>Здесь тестовый комплект занимает больше чем семь секунд, даже при том, что фактические тесты работают через менее чем одну десятую секунды. Чтобы ускорить это, мы можем открыть отдельное окно терминала, переместиться к корневому каталогу Rails, и затем запустить сервер Spork:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
</pre></div>
</div>


<p>В другом окне терминала, мы теперь можем запустить наш набор тестов с <tt class="verb">--drb</tt> опцией<sup class="footnote" id="fnref:3.16"><a href="#fn:3.16">16</a></sup> и проверить что издержки, связанные с загрузкой окружения  намного сократились:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>rspec --drb spec/
<span class="go">..</span>


<span class="go">Finished in 0.10519 seconds</span>
<span class="go">2 examples, 0 failures</span>

<span class="go">real    0m0.803s</span>
<span class="go">user    0m0.354s</span>
<span class="go">sys     0m0.171s</span>
</pre></div>
</div>


<p>Как ожидалось, издержки были существенно сокращены.</p>

<p>Чтобы запустить RSpec и Spork с Autotest, нам нужно сконфигурировать RSpec для использования <tt class="verb">--drb</tt> опции по умолчанию, чего мы можем добиться добавлением ее в <code>.rspec</code> конфигурационный файл в корневой директории Rails (<a class="ref" href="static-pages#code:dot_rspec">Листинг&nbsp;3.14</a>).</p>

<div class="label" id="code:dot_rspec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.14.</span> <span class="description">Добавление <tt class="verb">--drb</tt> опции в <code>.rspec</code> файл.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="o">--</span><span class="n">colour</span>
<span class="o">--</span><span class="n">drb</span>
</pre></div>
</div></div>


<p>С этим обновлением <code>.rspec</code> файла, набор тестов должен запускаться также быстро как и прежде, без выполнения <tt class="verb">--drb</tt> опции:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> <span class="nb">time </span>rspec spec/
<span class="go">..</span>


<span class="go">Finished in 0.10926 seconds</span>
<span class="go">2 examples, 0 failures</span>

<span class="go">real    0m0.803s</span>
<span class="go">user    0m0.355s</span>
<span class="go">sys     0m0.171s</span>
</pre></div>
</div>


<p>Конечно, выполнение <code>time</code> здесь только для иллюстрации; обычно следует выполнять</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>или</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> autotest
</pre></div>
</div>


<p>без <code>time</code> команды.</p>

<p>Один небольшой совет при использовании Spork: если ваши тесты перестали работать, когда вы думаете, что они должны проходить, проблемой может быть в загрузке Spork  prefork, которая может иногда препятствовать тому, чтобы необходимые файлы были перезагружены. Когда вы сомневаетесь, выйдете из сервера Spork <tt>Control-C</tt> и перезапустите его:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>spork
<span class="go">Using RSpec</span>
<span class="go">Loading Spork.prefork block...</span>
<span class="go">Spork is ready and listening on 8989!</span>
<span class="go">^C</span>
<span class="gp">$</span> bundle <span class="nb">exec </span>spork
</pre></div>
</div>




<div class="label" id="sec:red"></div>


<h4><a id="sec:3.2.2.2" href="static-pages#sec:red" class="heading" style= "color: red;">Красный</a></h4>


<p>Теперь давайте перейдем к красной части цикла-зеленый красный, написав провальный тест для <code>about</code> страницы. Следуя модели из <a class="ref" href="static-pages#code:default_pages_controller_spec">Листинга&nbsp;3.11</a>, вы, наверное, сможете предугадать правильный тест (<a class="ref" href="static-pages#code:failing_about_page">Листинг&nbsp;3.15</a>).</p>

<div class="label" id="code:failing_about_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.15.</span> <span class="description">Pages controller spec с провальным тестом на About страницу.<br /> <code>spec/controllers/pages_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;contact&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;about&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;about&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что мы добавили строку, которая говорит RSpec <em>интегрировать представления</em> внутрь контроллера тестов. Иными словами, по умолчанию RSpec тестирует только действия внутри контроллера тестов, если мы также хотим интерпретировать представления, мы должны сказать об этом явно во второй строке:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
</pre></div>
</div>


<p>Это гарантирует, что если тест пройден, то страница действительно существует.</p>

<p>Новый тест пытается <code>get</code> (получить) <code>about</code> действие, и указывает, что в результате ответом должен быть успех. По задумке, он провалится (с красным сообщением об ошибке), как показано на <a class="ref" href="static-pages#fig:rspec_spec_red">Рис.&nbsp;3.7</a> (<code>rspec spec/</code>) и <a class="ref" href="static-pages#fig:autotest_red">Рис.&nbsp;3.8</a> (<code>autotest</code>). (Если вы тестируете представления в контроллерах как это рекомендовано в этом учебнике, стоит отметить, что изменение файла представления не будет запрашивать Autotest запустить соответствующий тест контроллера. Наверное, есть способ как-то настроить Autotest чтобы делать это автоматически, но обычно я всего лишь перехожу в контроллер и нажимаю &ldquo;space-backspace&rdquo; (пробел-удалить) что помечает файл как измененный. Сохранение контроллера это повод для Автотеста выполнить тесты, что от него и требуется.)</p>

<div class="label" id="fig:rspec_spec_red"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rspec_spec_red.png" alt="rspec_spec_red" /></span></div><div class="caption"><span class="header">Рисунок  3.7: </span><span class="description">Провальный spec для About страницы с использованием <code>spec spec/</code>.&nbsp;<a href="http://railstutorial.org/images/figures/rspec_spec_red-full.png">(полный размер)</a></span></div></div>




<div class="label" id="fig:autotest_red"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_red.png" alt="autotest_red" /></span></div><div class="caption"><span class="header">Рисунок  3.8: </span><span class="description">Провальный spec для About страницы с использованием Autotest&nbsp;<a href="http://railstutorial.org/images/figures/autotest_red-full.png">(полный размер)</a></span></div></div>


<p>Это Красный. Давайте перейдем к Зеленому.</p>

<div class="label" id="sec:green"></div>


<h4><a id="sec:3.2.2.3" href="static-pages#sec:green" class="heading" style= "color: green;">Зеленый</a></h4>


<p>Напомним, из <a class="ref" href="static-pages#sec:static_pages_with_rails">Раздела&nbsp;3.1.2</a> что мы можем генерировать статичные страницы в Rails, создавая действие и соответствующее представление с названием страницы. В нашем случае, страница About в первую очередь нуждается в действии с названием <code>about</code> в контроллере Pages. Написав провальный тест, мы можем быть уверены, что, если он пройдет, то это фактически будет означать, что мы создали рабочую <code>about</code> страницу.</p>

<p>Следуя модели предоставленной <code>home</code> и <code>contact</code> в <a class="ref" href="static-pages#code:pages_controller">Листинг&nbsp;3.6</a>, давайте сначала добавим <code>about</code> действие в контроллер Pages (<a class="ref" href="static-pages#code:adding_the_about_page">Листинг&nbsp;3.16</a>).</p>

<div class="label" id="code:adding_the_about_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.16.</span> <span class="description">Pages контроллер с добавленным <code>about</code> действием. <br /> <code>app/controllers/pages_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>затем мы добавим <code>about</code> действие в файл маршрутов (<a class="ref" href="static-pages#code:about_route">Листинг&nbsp;3.17</a>).</p>

<div class="label" id="code:about_route"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.17.</span> <span class="description">Добавление <code>about</code> маршрута. <br /> <code>config/routes.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">&quot;pages/home&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;pages/contact&quot;</span>
  <span class="n">get</span> <span class="s2">&quot;pages/about&quot;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Наконец, добавим <code>about</code> представление. В итоге мы заполним его чем-то более информативным, но сейчас мы будем просто подражать содержанию сгенерированных представлений (<a class="ref" href="static-pages#code:raw_home_view">Листинг&nbsp;3.7</a> и <a class="ref" href="static-pages#code:raw_contact_view">Листинг&nbsp;3.8</a>) для <code>about</code> представления  (<a class="ref" href="static-pages#code:raw_about_view">Листинг&nbsp;3.18</a>).</p>

<div class="label" id="code:raw_about_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.18.</span> <span class="description">Заглушка About страницы. <br /> <code>app/views/pages/about.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Pages#about<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/pages/about.html.erb<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Запуск specs или обновленное изображение Autotest (<a class="ref" href="static-pages#fig:autotest_back_to_green">Рис.&nbsp;3.9</a>) должно вернуть нас к Зеленому:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<div class="label" id="fig:autotest_back_to_green"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_back_to_green.png" alt="autotest_back_to_green" /></span></div><div class="caption"><span class="header">Рисунок  3.9: </span><span class="description">Autotest вернулся к Зеленому: все тесты проходят.&nbsp;<a href="http://railstutorial.org/images/figures/autotest_back_to_green-full.png">(полный размер)</a></span></div></div>


<p>Конечно, это никогда не плохая идея, чтобы посмотреть на страницу в браузере, чтобы убедиться, что наши тесты не являются абсолютно сумасшедшими (<a class="ref" href="static-pages#fig:raw_about_page">Рис.&nbsp;3.10</a>).</p>

<div class="label" id="fig:raw_about_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/raw_about_page.png" alt="raw_about_page" /></span></div><div class="caption"><span class="header">Рисунок  3.10: </span><span class="description">Новая (и довольно сырая) About страница (<a href="http://localhost:3000/pages/about"><tt>/pages/about</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/raw_about_page-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:refactor"></div>


<h4><a id="sec:3.2.2.4" href="static-pages#sec:refactor" class="heading">Реорганизация</a></h4>

<p>Теперь, когда мы Позеленели, мы свободны, чтобы <em>реорганизовать</em> наш код, изменяя его форму, не меняя его функции. Часто код начинает "вонять", что означает, что он становится уродливым, раздутым, или наполненным повторениями. Компьютеру все равно, конечно, но не людям, поэтому важно сохранить базу кода в чистоте, часто делая рефакторинг (реорганизацию). Наличие хороших (проходящих!) тестов является бесценным инструментом в этой связи, так как это резко снижает вероятность ошибки при внедрении рефакторинга.</p>

<p>Наш пример приложения слишком мал, чтобы реорганизовать его прямо сейчас, но вонь от кода проникает в каждую трещину, так что нам не придется долго ждать: мы займемся рефакторингом (реорганизацией) в <a class="ref" href="static-pages#sec:instance_variables_embedded_ruby">Разделе&nbsp;3.3.3</a>.</p>

<div class="label" id="sec:slightly_dynamic_pages"></div>


<h2><a id="sec:3.3" href="static-pages#sec:slightly_dynamic_pages" class="heading"><span class="number">3.3</span> Немного динамические страницы</a></h2>


<p>Теперь, когда мы создали действия и представления для нескольких статических страниц, мы сделаем их <em>чуть-чуть</em> динамическими, добавив содержимое, которое будет меняться на каждой странице: мы получим заголовок (тайтл) каждой страницы, изменяющийся, отражая ее содержание. Является ли это <em>действительно</em> динамическим контентом&nbsp;&mdash;&nbsp;спорно, но это в любом случае закладывает необходимую основу для однозначно динамического содержимого в <a class="ref" href="sign-up#top">Главе&nbsp;8</a>.</p>

<p>(Если вы пропустили материал TDD в <a class="ref" href="static-pages#sec:first_tests">Разделе&nbsp;3.2</a>, не забудьте создать About страницу в этой точке используя код из <a class="ref" href="static-pages#code:adding_the_about_page">Листинга&nbsp;3.16</a>, <a class="ref" href="static-pages#code:about_route">Листинга&nbsp;3.17</a>, и <a class="ref" href="static-pages#code:raw_about_view">Листинга&nbsp;3.18</a>.)</p>

<div class="label" id="sec:testing_a_title_change"></div>


<h3><a id="sec:3.3.1" href="static-pages#sec:testing_a_title_change" class="heading"><span class="number">3.3.1</span> Тестирование изменения заголовка</a></h3>


<p>Наш план заключается в редактировании Home, Contact, и About страниц, чтобы добавить им тип структуры HTML который мы видели в <a class="ref" href="static-pages#code:hello_world">Листинге&nbsp;3.3</a>, в том числе заголовок (тайтл), который меняется на каждой странице. Это деликатный вопрос - какие из этих изменений, проверять, и в целом тестирование HTML может быть весьма хрупким, так как содержание склонно к частым изменениям. Мы сохраним наши тесты простыми, путем тестирования только заголовков страниц.</p>

<div class="label" id="table:static_pages"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_center"><strong>Страница</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Базовый заголовок</strong></th><th class="align_left"><strong>Переменный заголовок</strong></th></tr><tr class="top_bar"><td class="align_center">Home</td><td class="align_left"><tt>/pages/home</tt></td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>" | Home"</code></td></tr><tr><td class="align_center">Contact</td><td class="align_left"><tt>/pages/contact</tt></td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>" | Contact"</code></td></tr><tr><td class="align_center">About</td><td class="align_left"><tt>/pages/about</tt></td><td class="align_left"><code>"Ruby on Rails Tutorial Sample App"</code></td><td class="align_left"><code>" | About"</code></td></tr></table></div><div class="caption"><span class="header">Таблица 3.1: </span><span class="description">(В основном) статические страницы для примера приложения.</span></div></div>


<p>К концу этого раздела, все три наши статические страницы будут иметь заголовок (тайтл) вида &ldquo;Ruby on Rails Tutorial Sample App | Home&rdquo;, где последняя часть заголовка будет меняться в зависимости от страницы (<a class="ref" href="static-pages#table:static_pages">Таблица&nbsp;3.1</a>). Мы достроим тесты из <a class="ref" href="static-pages#code:failing_about_page">Листинга&nbsp;3.15</a>, добавив тест заголовка (тайтла) в соответствии с моделью в <a class="ref" href="static-pages#code:title_test">Листинге&nbsp;3.19</a>.</p>

<div class="label" id="code:title_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.19.</span> <span class="description">Тест заголовков.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                    <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>При этом используется <code>have_selector</code> метод внутри RSpec; он проверяет содержание HTML элемента (&ldquo;селектора&rdquo;). Другими словами, код</p>

<div class="code"><div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                  <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>проверяет, что контент содержащийся внутри <tt class="verb">&lt;title&gt;&lt;/title&gt;</tt> тегов, это <code>"Ruby on Rails Tutorial Sample App | Home"</code>.<sup class="footnote" id="fnref:3.17"><a href="#fn:3.17">17</a></sup> Стоит отметить, что содержание не должно точно соответствовать, любая подстрока также сработает, так что</p>

<div class="code"><div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot; | Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>совпадет также как и полный заголовок.<sup class="footnote" id="fnref:3.18"><a href="#fn:3.18">18</a></sup></p>

<p>Обратите внимание, что в <a class="ref" href="static-pages#code:title_test">Листинге&nbsp;3.19</a> я разбил материал внутри <code>have_selector</code> на две строки; это говорит вам нечто важное о синтаксисе Ruby: Ruby не заботится о новых строках.<sup class="footnote" id="fnref:3.19"><a href="#fn:3.19">19</a></sup> <em>Причиной</em>, по которой я решил разорвать код на куски является то, что я предпочитаю не применять строки исходного кода длиной более 80 символов&nbsp;&mdash;&nbsp;для читабельности.<sup class="footnote" id="fnref:3.20"><a href="#fn:3.20">20</a></sup> В настоящий момент я все еще нахожу этот формат кода довольно уродливым; в  <a class="ref" href="static-pages#sec:static_pages_exercises">Разделе&nbsp;3.5</a> есть упражнение по рефакторингу, которое делает его намного более симпатичным.<sup class="footnote" id="fnref:3.21"><a href="#fn:3.21">21</a></sup></p>

<p>Добавление новых тестов для каждой из трех наших статических страниц, в соответствии с моделью из <a class="ref" href="static-pages#code:title_test">Листинга&nbsp;3.19</a> дает нам новый Pages controller spec (<a class="ref" href="static-pages#code:pages_controller_spec_title">Листинг&nbsp;3.20</a>).</p>

<div class="label" id="code:pages_controller_spec_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.20.</span> <span class="description">Pages_controller_spec с тестами заголовков (тайтлов). <br /> <code>spec/controllers/pages_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                        <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;contact&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                        <span class="ss">:content</span> <span class="o">=&gt;</span>
                          <span class="s2">&quot;Ruby on Rails Tutorial Sample App | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;about&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;about&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;about&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                        <span class="ss">:content</span> <span class="o">=&gt;</span>
                          <span class="s2">&quot;Ruby on Rails Tutorial Sample App | About&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Обратите внимание, что <code>render_views</code> строка,  введенная в  <a class="ref" href="static-pages#code:failing_about_page">Листинг&nbsp;3.15</a> необходима тестам заголовков (тайтлов) для работы.</p>

<p>С этими тестами, вы должны запустить</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
</pre></div>
</div>


<p>или используйте Autotest чтобы проверить, что наш код в Красном (провальный тест).</p>

<div class="label" id="sec:passing_title_tests"></div>


<h3><a id="sec:3.3.2" href="static-pages#sec:passing_title_tests" class="heading"><span class="number">3.3.2</span> Прохождение тестов заголовка</a></h3>


<p>Теперь мы заставим тесты заголовков пройти, и в то же время добавим полную структуру HTML чтобы сделать валидные веб-страницы. Давайте начнем с Home страницы (<a class="ref" href="static-pages#code:home_view_full_html">Листинг&nbsp;3.21</a>), используя тот же основной скелет HTML, как в &ldquo;hello&rdquo; странице из <a class="ref" href="static-pages#code:hello_world">Листинга&nbsp;3.3</a>.</p>

<p><em>Примечание:</em> в Rails&nbsp;3, генератор контроллера создает <em>layout</em> файл, чье назначение мы вскоре объясним, но который пока следует удалить перед продолжением:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rm app/views/layouts/application.html.erb
</pre></div>
</div>


<div class="label" id="code:home_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.21.</span> <span class="description">Представление для Home страницы с полной HTML структурой. <br /> <code>app/views/pages/home.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="static-pages#code:home_view_full_html">Листинг&nbsp;3.21</a> использует заголовки, протестированные в <a class="ref" href="static-pages#code:pages_controller_spec_title">Листинге&nbsp;3.20</a>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Home<span class="nt">&lt;/title&gt;</span>
</pre></div>
</div>


<p>Как результат, тесты для Home страницы теперь должны пройти. Мы все еще в Красном из-за провальных Contact и About тестов, и мы можем попасть в Зеленый с кодом из <a class="ref" href="static-pages#code:contact_view_full_html">Листинга&nbsp;3.22</a> и <a class="ref" href="static-pages#code:about_view_full_html">Листинга&nbsp;3.23</a>.</p>

<div class="label" id="code:contact_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.22.</span> <span class="description">Представление для Contact страницы с полной HTML структурой. <br /> <code>app/views/pages/contact.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | Contact<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Contact Ruby on Rails Tutorial about the sample app at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/feedback&quot;</span><span class="nt">&gt;</span>feedback page<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_full_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.23.</span> <span class="description">Представление для About страницы с полной HTML структурой. <br /> <code>app/views/pages/about.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | About<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Эти примеры страниц вводят <code>anchor</code> тег (тег привязки, якорный тег)&nbsp;<code>a</code>, который создает ссылки на заданный URL-адрес (так называемый &ldquo;href&rdquo;, или &ldquo;гипертекстовая ссылка&rdquo;, в контексте анкор (якорного, привязки) тега):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>Вы можете увидеть результаты на <a class="ref" href="static-pages#fig:new_home_page">Рис.&nbsp;3.11</a>.</p>

<div class="label" id="fig:new_home_page"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/new_home_page.png" alt="new_home_page" /></span></div><div class="caption"><span class="header">Рисунок  3.11: </span><span class="description">Минимальная Home страница для примера приложения (<a href="http://localhost:3000/pages/home"><tt>/pages/home</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/new_home_page-full.png">(полный размер)</a></span></div></div>




<div class="label" id="sec:instance_variables_embedded_ruby"></div>


<h3><a id="sec:3.3.3" href="static-pages#sec:instance_variables_embedded_ruby" class="heading"><span class="number">3.3.3</span> Переменные экземпляра и Embedded (встроенный) Ruby</a></h3>


<p>Мы уже многого добились в этом разделе, создав три валидные страницы с использованием Rails контроллеров и действий, но они содержат чисто статический HTML и, следовательно, не показывают силу Rails. Кроме того, они страдают от ужасного дублирования:</p><br/>

<ul><li>Заголовки страниц почти (но не совсем) одинаковые.</li>
<li>&ldquo;Ruby on Rails Tutorial Sample App&rdquo; является общим для всех трех заголовков (тайтлов).</li>
<li>Весь скелет структуры HTML повторяется на каждой странице.</li></ul>

<p>Этот повторный код - нарушение важного, &ldquo;Don&rsquo;t Repeat Yourself&rdquo; (DRY, Не Повторяй Себя) принципа; в этом и следующем разделах мы будем “DRY (сушить) наш код”, удаляя повторения.</p>

<p>Как это ни парадоксально, но первым шагом на пути устранения дублирования будет усиление дублирования: мы сделаем названия страниц, которые в настоящее время очень похожи, <em>полностью</em> совпадающими. Это позволит легко удалить все повторения одним махом.</p>



<p>Техника включает в себя создание <em>переменных экземпляра</em> в наших действиях. Так как заголовки (тайтлы) имеют переменную составляющую, мы установим переменную <code>@title</code> (произносится как "эт тайтл") в соответствующий заголовок для каждого действия  (<a class="ref" href="static-pages#code:pages_controller_with_title">Листинг&nbsp;3.24</a>).</p>

<div class="label" id="code:pages_controller_with_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.24.</span> <span class="description">Контроллер Pages с заголовком для каждой страницы. <br /> <code>app/controllers/pages_controller.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Home&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">contact</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Contact&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">about</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;About&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Выражение</p>

<div class="code"><div class="highlight"><pre><span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Home&quot;</span>
</pre></div>
</div>


<p>это <em>назначение</em>, в данном случае, создать новую переменную <code>@title</code> со значением <code>"Home"</code>. Знак собака&nbsp;<code>@</code> в <code>@title</code> указывает, что она является переменной экземпляра. Переменные экземпляра имеют более общий смысл в Ruby (см. <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">Раздел&nbsp;4.2.3</a>),  но в Rails их роль в первую очередь в связывании действий и представлений: любая переменная экземпляра, определенная в <code>home</code> действии автоматически доступна в <code>home.html.erb</code> представлении, и так далее, для остальных пар действие/представление.<sup class="footnote" id="fnref:3.22"><a href="#fn:3.22">22</a></sup></p>

<p>Мы можем увидеть как это работает, заменив буквальный заголовок &ldquo;Home&rdquo; содержимым <code>@title</code> переменной в <code>home.html.erb</code> представлении (<a class="ref" href="static-pages#code:home_view_erb_title">Листинг&nbsp;3.25</a>).</p>

<div class="label" id="code:home_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.25.</span> <span class="description">Представление для страницы Home с Embedded (встроенным) Ruby заголовком. <br /> <code>app/views/pages/home.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      This is the home page for the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      sample application.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p><a class="ref" href="static-pages#code:home_view_erb_title">Листинг&nbsp;3.24</a> это наш первый пример <em>Embedded Ruby</em>, который также называется <em>ERb</em>. (Теперь вы знаете, почему HTML представления имеют расширение файла <code>.html.erb</code>.) ERb является основным механизмом в Rails для включения динамического контента в веб-страницы.<sup class="footnote" id="fnref:3.23"><a href="#fn:3.23">23</a></sup> Код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>указывает с помощью <tt class="verb">&lt;%= ... %&gt;</tt> что рельсы должны вставить содержимое <code>@title</code> переменной, каким бы оно ни было. Когда мы посещаем <tt>/pages/home</tt>, Rails выполняет тело <code>home</code> действия, что назначает <code>@title = "Home"</code>, поэтому в данном случае</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>заменяется на &ldquo;Home&rdquo;. Затем Rails интерпретирует представление, используя ERb для вставки значения <code>@title</code> в шаблон, который веб-сервер затем посылает на ваш браузер как HTML. Результат тот же, что и раньше, только теперь переменная часть заголовка генерируется ERb(-ой) динамически.</p>

<p>Мы можем проверить, что все это работает, запустив тесты из  <a class="ref" href="static-pages#sec:testing_a_title_change">Раздела&nbsp;3.3.1</a> и увидев, что они все еще проходят. Затем мы можем сделать соответствующие замены для Contact и About страниц (<a class="ref" href="static-pages#code:contact_view_erb_title">Листинг&nbsp;3.26</a> и <a class="ref" href="static-pages#code:about_view_erb_title">Листинг&nbsp;3.27</a>).</p>

<div class="label" id="code:contact_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.26.</span> <span class="description">Представление для страницы Contact с Embedded Ruby заголовком.<br /> <code>app/views/pages/contact.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      Contact Ruby on Rails Tutorial about the sample app at the
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/feedback&quot;</span><span class="nt">&gt;</span>feedback page<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_erb_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.27.</span> <span class="description">Представление для страницы About с Embedded Ruby заголовком.<br /> <code>app/views/pages/about.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
      is a project to make a book and screencasts to teach web development
      with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
      is the sample application for the tutorial.
    <span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Как и раньше, тесты проходят.</p>

<div class="label" id="sec:layouts"></div>


<h3><a id="sec:3.3.4" href="static-pages#sec:layouts" class="heading"><span class="number">3.3.4</span> Устранение дублирования шаблонами</a></h3>


<p>Теперь, когда мы заменили переменную часть названия страниц переменной экземпляра и ERb, каждая из наших страниц выглядит примерно так:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
      Contents
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>


<p>Другими словами, <em>все</em> наши страницы имеют одинаковую структуру, в том числе, заголовки (из-за Embedded Ruby), единственно исключая содержимое каждой страницы.</p>

<p>Было бы неплохо, если бы существовал способ для исключения общих элементов в какой-то глобальный макет, с телом контента вставленным на каждой странице? Действительно, это было бы неплохо, и Rails счастливо обязывают использовать специальный файл, называемый <code>application.html.erb</code>, который живет в <code>layouts</code> каталоге. Чтобы захватить структурный каркас, создайте <code>application.html.erb</code> и залейте в него содержимое  <a class="ref" href="static-pages#code:application_layout">Листинга&nbsp;3.28</a>.</p>

<div class="label" id="code:application_layout"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.28.</span> <span class="description">Шаблон сайта «Пример Приложения». <br /> <code>app/views/layouts/application.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Ruby on Rails Tutorial Sample App | <span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tag</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Отметим здесь, специальную строку</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Этот код отвечает за вставку содержимого каждой страницы в шаблон. Как и с <tt class="verb">&lt;%= @title %&gt;</tt>, <tt class="verb">&lt;% ... %&gt;</tt> теги указывают на Embedded Ruby, и знак равенства в <tt class="verb">&lt;%= ... %&gt;</tt> гарантирует, что результат оценки выражения вставится в нужный момент в шаблон. (Не беспокойтесь о значении слова &ldquo;yield&rdquo; в этом контексте;<sup class="footnote" id="fnref:3.24"><a href="#fn:3.24">24</a></sup> важно то, что использование этого шаблона обеспечивает, что при посещении страницы <tt>/pages/home</tt> содержимое <code>home.html.erb</code> преобразуется в HTML а затем вставляется вместо <tt class="verb">&lt;%= yield %&gt;</tt>).</p>

<p>Теперь, когда у нас есть шаблон  всего сайта, мы также используем эту возможность, чтобы добавить средство защиты к каждой странице. <a class="ref" href="static-pages#code:application_layout">Листинг&nbsp;3.28</a> добавляет код</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">csrf_meta_tag</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>который использует Rails метод <code>csrf_meta_tag</code> чтобы предотвратить <a  href="http://ru.wikipedia.org/wiki/CSRF">подделку межсайтовых запросов</a> (CSRF), тип злонамеренной веб-атаки. Не волнуйтесь о деталях (я не волнуюсь); только знайте, что Rails упорно трудится, чтобы сохранить ваше приложение безопасным.</p>

<p>Конечно, наши представления <a class="ref" href="static-pages#code:home_view_erb_title">Листинг&nbsp;3.25</a>, <a class="ref" href="static-pages#code:contact_view_erb_title">Листинг&nbsp;3.26</a>, и <a class="ref" href="static-pages#code:about_view_erb_title">Листинг&nbsp;3.27</a> все еще наполнены всей структурой HTML, которую мы только поместили в макет, таким образом, мы должны убрать ее (структуру), оставив только внутреннее содержание. Почищенные представления показаны в  <a class="ref" href="static-pages#code:home_view_interior">Листинге&nbsp;3.29</a>, <a class="ref" href="static-pages#code:contact_view_interior">Листинге&nbsp;3.30</a>, и <a class="ref" href="static-pages#code:about_view_interior">Листинге&nbsp;3.31</a>.</p>

<div class="label" id="code:home_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.29.</span> <span class="description">Home представление с удаленной структурой HTML. <br /> <code>app/views/pages/home.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  This is the home page for the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  sample application.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:contact_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.30.</span> <span class="description">Contact представление с удаленной структурой HTML. <br /> <code>app/views/pages/contact.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Contact<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Contact Ruby on Rails Tutorial about the sample app at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/feedback&quot;</span><span class="nt">&gt;</span>feedback page<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:about_view_interior"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.31.</span> <span class="description">About представление с удаленной структурой HTML. <br /> <code>app/views/pages/about.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>About Us<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
  is a project to make a book and screencasts to teach web development
  with <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://rubyonrails.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails<span class="nt">&lt;/a&gt;</span>. This
  is the sample application for the tutorial.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>С таким определением представлений, Home, Contact, и About страницы точно такие же, как и прежде, то есть, мы успешно реструктурировали их, но дублирования стало гораздо меньше. И, как и требовалось, тесты по-прежнему проходят.</p>

<div class="label" id="sec:static_pages_conclusion"></div>


<h2><a id="sec:3.4" href="static-pages#sec:static_pages_conclusion" class="heading"><span class="number">3.4</span> Заключение</a></h2>


<p>При взгляде со стороны, в этой главе мы вряд ли чего то добились: мы начали со статических страниц, а закончили&hellip; <em>в основном</em> статическими страницами. Но внешность обманчива: разрабатывая в терминах Rails, контроллеры, действия и представления, мы теперь в состоянии добавить произвольное количество динамического содержимого на нашем сайте.</p>

<p>Прежде чем двигаться дальше, давайте потратим минуту, чтобы зафиксировать (commit) наши изменения и объединить их с мастер веткой (branch). Еще в <a class="ref" href="static-pages#sec:static_pages_with_rails">Разделе&nbsp;3.1.2</a> мы создали ветку (branch) Git для разработки статических страниц. Если вы еще не делали фиксацию (commit), пока мы двигались вперед, сначала сделайте фиксацию показывающую, что мы достигли точки остановки:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Done with static pages&quot;</span>
</pre></div>
</div>


<p>Затем объедините изменения с мастер веткой (branch), используя ту же технику, что и в <a class="ref" href="beginning#sec:git_commands">Разделе&nbsp;1.3.5</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge static-pages
</pre></div>
</div>


<p>Как только вы достигаете точки остановки, такой как эта, обычно это хорошая идея, чтобы отправить (to push) ваш код в удаленное хранилище (которым, если вы следовали шагам в <a class="ref" href="beginning#sec:github">Разделе&nbsp;1.3.4</a>, будет GitHub):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
<span class="gp">$</span> git push
</pre></div>
</div>


<p>Если вы хотите, в этот момент вы можете даже развернуть обновленное приложение в Heroku:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle <span class="nb">exec </span>rspec spec/
<span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Отметим, что в обоих случаях я запускаю <code>rspec spec/</code>, просто чтобы быть уверенным, что все тесты все еще проходят. Запуск тестов перед отправкой или развертыванием, является хорошей привычкой.</p>

<div class="label" id="sec:static_pages_exercises"></div>


<h2><a id="sec:3.5" href="static-pages#sec:static_pages_exercises" class="heading"><span class="number">3.5</span> Упражнения</a></h2>




<ol>

<li>Сделать страницу Help для примера приложения. Вначале написать тест на существование страницы в URL <tt>/pages/help</tt>. Затем написать второй тест для заголовка &ldquo;Ruby on Rails Tutorial Sample App | Help&rdquo;. Получите прохождение ваших тестов, а затем заполните Help страницу содержанием из <a class="ref" href="static-pages#code:help_page">Листинга&nbsp;3.32</a>.</li>

<li>Вы могли заметить, некоторые повторения в Pages контроллере spec (<a class="ref" href="static-pages#code:pages_controller_spec_title">Листинг&nbsp;3.20</a>). В частности, база заголовка &ldquo;Ruby on Rails Tutorial Sample App&rdquo;, является одинаковой для всех заголовков в тесте. Используя RSpec <code>before(:each)</code> объект, который выполняет блок кода перед каждым тестом, заполните <a class="ref" href="static-pages#code:pages_controller_spec_exercise">Листинг&nbsp;3.33</a> чтобы определить <code>@base_title</code> переменную экземпляра, которая устранит это дублирование. (Этот код использует два новых элемента: <em>символ</em>, <code>:each</code>, и оператор конкатенации строк <code>+</code>. Мы узнаем больше о них в <a class="ref" href="rails-flavored-ruby#top">Главе&nbsp;4</a>, и мы увидим <code>before(:each)</code> снова в <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">Разделе&nbsp;6.2.1</a>.) Note that, with the base title captured in an instance variable, we are now able to align <code>:content</code> with the first character inside each left parenthesis&nbsp;<code>(</code>. This is my preferred convention for formatting code broken into multiple lines.(??)</li>

<li>Установка гема Autotest в <a class="ref" href="static-pages#sec:autotest">Разделе&nbsp;3.2.1.1</a> вероятно должна происходить в <code>:test</code> части <code>Gemfile</code>. Добавьте Autotest в <code>Gemfile</code> раскомментировав соответствующие строки в <a class="ref" href="static-pages#code:gemfile_autotest">Листинге&nbsp;3.34</a>. Затем запустите <code>bundle install</code> и проверьте, что вы можете запустить Autotest используя <code>bundle exec autotest</code>. <em>Дополнительно</em>: Запустите <tt class="verb">bundle install --binstubs</tt> чтобы у вас была возможность запускать Autotest используя <code>bin/autotest</code>.</li>

</ol>




<div class="label" id="code:help_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.32.</span> <span class="description">Код для предложенной страницы Help. <br /> <code>app/views/pages/help.html.erb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Help<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>
  Get help on Ruby on Rails Tutorial at the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/help&quot;</span><span class="nt">&gt;</span>Rails Tutorial help page<span class="nt">&lt;/a&gt;</span>.
  To get help on this sample app, see the
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/book&quot;</span><span class="nt">&gt;</span>Rails Tutorial book<span class="nt">&lt;/a&gt;</span>.
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:pages_controller_spec_exercise"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.33.</span> <span class="description">Pages контроллер spec с базовым заголовком. <br /> <code>spec/controllers/pages_controller_spec.rb</code></span>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1">#</span>
    <span class="c1"># Define @base_title here.</span>
    <span class="c1">#</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;home&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                                    <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@base_title</span> <span class="o">+</span> <span class="s2">&quot; | Home&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;contact&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;contact&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                                    <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@base_title</span> <span class="o">+</span> <span class="s2">&quot; | Contact&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;about&#39;&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;about&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;about&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                                    <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@base_title</span> <span class="o">+</span> <span class="s2">&quot; | About&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<div class="label" id="code:gemfile_autotest"></div>


<div class="codelisting">
<div class="listing"><span class="header">Листинг 3.34.</span> <span class="description">Добавление Autotest в <code>Gemfile</code>.</span>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">'http://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.0.9'</span>
<span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="s1">'1.3.3'</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.6.1'</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'rspec-rails'</span><span class="p">,</span> <span class="s1">'2.6.1'</span>
  <span class="n">gem</span> <span class="s1">'webrat'</span><span class="p">,</span> <span class="s1">'0.7.1'</span>
  <span class="c1"># gem 'autotest', '4.4.6'</span>
  <span class="c1"># gem 'autotest-rails-pure', '4.1.2'</span>
  <span class="c1"># gem 'autotest-fsevent', '0.2.4'</span>
  <span class="c1"># gem 'autotest-growl', '0.2.9'</span>
<span class="k">end</span>
</pre></div>
</div></div>

<div class="navigation">  <a class="prev_page" href="a-demo-app#top">
    &laquo;&nbsp;<span class="number">Глава 2</span> demo app
  </a>
  <a class="next_page" href="rails-flavored-ruby#top">
    <span class="number">Глава 4</span> Rails-приправленный Ruby&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:3.1">Как и прежде, увеличенный файл из <a class="ref" href="beginning#code:gitignore">Листинга&nbsp;1.6</a> может оказаться более удобным.&nbsp;<a class="arrow" href="#fnref:3.1">&uarr;</a></li>
<li id="fn:3.2">Фактически, Rails обеспечивает непопадание запросов на такие файлы в основной стек Rails; они поставляются непосредственно из файловой системы. (См. <a href="http://www.amazon.com/gp/product/0321601661?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0321601661"><em>The Rails&nbsp;3 Way</em></a> .)&nbsp;<a class="arrow" href="#fnref:3.2">&uarr;</a></li>
<li id="fn:3.3">Как обычно, замените <code>mate</code> командой для вашего текстового редактора.&nbsp;<a class="arrow" href="#fnref:3.3">&uarr;</a></li>
<li id="fn:3.4">HTML изменяется со временем; явно декларируя doctype  мы даем браузерам возможность отображать наши страницы должным образом в будущем. Чрезвычайно простой doctype <code>&lt;!DOCTYPE html&gt;</code> характерен для последнего стандарта HTML - HTML5.&nbsp;<a class="arrow" href="#fnref:3.4">&uarr;</a></li>
<li id="fn:3.5">Наш метод создания статических страниц является, вероятно, самым простым, но это не единственный путь. Оптимальный метод действительно зависит от ваших потребностей; если вы ожидаете, <em>большое</em> количество статических страниц, использование  контроллера Pages  может стать довольно громоздким, но в нашем демонстрационном приложении нам понадобятся лишь несколько. См. этот <a href="http://blog.hasmanythrough.com/2008/4/2/simple-pages">blog post on simple pages at <tt>has_many :through</tt></a> для обзора методов, изготовления статических страниц с Rails. <em>Предупреждение:</em> обсуждение довольно продвинутое, так что, вы можете захотеть подождать некоторое время прежде, чем попытаться понять его.&nbsp;<a class="arrow" href="#fnref:3.5">&uarr;</a></li>
<li id="fn:3.6">В контексте RSpec TDD также известен как Behavior Driven Development, или BDD. (Откровенно говоря, я не уверен, что есть большая разница.)&nbsp;<a class="arrow" href="#fnref:3.6">&uarr;</a></li>
<li id="fn:3.7"><a href="http://github.com/thoughtbot/shoulda">Shoulda</a> тестовая платформа является хорошей альтернативой (и фактически может использоваться с RSpec). Это - Другой Rails Путь, так сказать.&nbsp;<a class="arrow" href="#fnref:3.7">&uarr;</a></li>
<li id="fn:3.8">Также возможно использовать просто <tt>autotest-rails</tt>, но этот гем зависит от полного комплекта ZenTest, который вызвал проблемы на некоторых системах. <tt>autotest-rails-pure</tt> гем избегает этой зависимости.&nbsp;<a class="arrow" href="#fnref:3.8">&uarr;</a></li>
<li id="fn:3.9">Эти гемы по идее должны быть включены в <code>Gemfile</code> вместо установки через командную строку, но в этом случае <code>Gemfile</code> был бы системно-зависимым - ситуация, которой я стараюсь избегать в этом учебнике. Включение Autotest в  <code>Gemfile</code> оставлено в качестве упражнения (<a class="ref" href="static-pages#sec:static_pages_exercises">Section&nbsp;3.5</a>).&nbsp;<a class="arrow" href="#fnref:3.9">↑</a></li>
<li id="fn:3.10">Autotest Growl гем заставляет результаты испытаний быть автоматически выведенными на экран  монитора, тогда как gem FSEvent заставляет Автотест использовать события файловой системы OS&nbsp;X, чтобы инициировать комплект тестов, вместо того, чтобы непрерывно опрашивать файловую систему. Также отметьте, что с обоими гемами вы, возможно, должны были бы использовать обновленную версию, если вы пользуетесь OS&nbsp;X Snow Leopard.&nbsp;<a class="arrow" href="#fnref:3.10">&uarr;</a></li>
<li id="fn:3.11">http://fredschoeneman.posterous.com/pimp-your-autotest-notification&nbsp;<a class="arrow" href="#fnref:3.11">&uarr;</a></li>
<li id="fn:3.12">В контексте RSpec тесты часто называют <em>specs (спецификациями)</em>, но для простоты я буду обычно придерживаться термина &ldquo;test&rdquo;&mdash;<em>кроме</em> тех случаев, когда обращаюсь к файлу, такому как <code>pages_controller_spec</code>, тогда я запишу &ldquo;Pages контроллер spec&rdquo;.&nbsp;<a class="arrow" href="#fnref:3.12">&uarr;</a></li>
<li id="fn:3.13">У большинства IDE также есть интерфейс для тестирования, но как отмечено в <a class="ref" href="beginning#sec:development_tools">Разделе&nbsp;1.2.1</a> я имею ограниченный опыт взаимодействия с этими инструментами.&nbsp;<a class="arrow" href="#fnref:3.13">&uarr;</a></li>
<li id="fn:3.14">Вы можете также запустить <code>bundle exec rake spec</code>, который в основном эквивалентен. (Раздражающе, если вы хотите запустить <code>rake spec</code> здесь, необходимо запустить <code>rake db:migrate</code> сначала, даже при том, что тесты в этой главе не требуют базы данных.)&nbsp;<a class="arrow" href="#fnref:3.14">&uarr;</a></li>
<li id="fn:3.15"><em>Spork</em> это комбинация spoon-fork (ложка-вилка). Название проекта обыгрывает использование Spork-ом <a href="http://ru.wikipedia.org/wiki/%D0%A4%D0%BE%D1%80%D0%BA">форков</a> <a href="http://ru.wikipedia.org/wiki/POSIX">POSIX-а</a>.&nbsp;<a class="arrow" href="#fnref:3.15">&uarr;</a></li>
<li id="fn:3.16">DRb обозначает &ldquo;Distributed Ruby&rdquo; (&ldquo;Распределенный Ruby&rdquo;).&nbsp;<a class="arrow" href="#fnref:3.16">&uarr;</a></li>
<li id="fn:3.17">Мы узнаем в <a class="ref" href="rails-flavored-ruby#sec:hashes_and_symbols">Разделе&nbsp;4.3.3</a> что <code>:content =&gt; "&hellip;"</code> синтаксис является <em>хэшем</em> использующим <em>symbol</em> в качестве ключа.&nbsp;<a class="arrow" href="#fnref:3.17">&uarr;</a></li>
<li id="fn:3.18">Я считаю это шагом назад от RSpec&nbsp;1.3, который использовал <code>have_tag</code> в этом контексте, который мог использоваться, чтобы потребовать точного совпадения. К сожалению, начиная с этой записи <code>have_tag</code> более не доступен в RSpec&nbsp;2.&nbsp;<a class="arrow" href="#fnref:3.18">&uarr;</a></li>
<li id="fn:3.19">Новая строка - то, что прибывает в конце строки, начинающая, ну, в общем, новую строку. В коде это представляется символом <tt class="verb">\n</tt>.&nbsp;<a class="arrow" href="#fnref:3.19">&uarr;</a></li>
<li id="fn:3.20"><em>Подсчет</em> столбцов вручную можг бы свести вас с ума, вот почему у многих текстовых редакторов есть визуальное средство для помощи вам. Рассмотрите TextMate, например; если вы взглянете на <a class="ref" href="beginning#fig:editor_shell">Рис.&nbsp;1.1</a>, вы увидите маленькую вертикальную линию справа, помогающую сохранить код в размере не более 80 символов. (Фактически это 78 столбцов, что дает вам небольшое поле для ошибки.) Если вы используете TextMate, можно найти эту функцию в <tt>View &gt; Wrap Column &gt; 78</tt>.&nbsp;<a class="arrow" href="#fnref:3.20">&uarr;</a></li>
<li id="fn:3.21">Rails 2.3/RSpec 1.3, использовал более короткий  <code>have_tag</code> вместо <code>have_selector</code>, и <code>:content</code> параметр также не был необходим. Более новый не всегда лучше;&nbsp;<a class="arrow" href="#fnref:3.21">&uarr;</a></li>
<li id="fn:3.22">На самом деле, переменная экземпляра фактически видима в <em>любом</em> представлении, факт, который мы используем в <a class="ref" href="sign-up#sec:a_working_form">Разделе&nbsp;8.2.2</a>.&nbsp;<a class="arrow" href="#fnref:3.22">&uarr;</a></li>
<li id="fn:3.23">Есть вторая популярная система шаблонов  под названием <a href="http://haml-lang.com/">Haml</a>, которую я лично люблю, но она все же <em>достаточно</em> нестандартна для использования во вводном учебном руководстве. Если есть достаточный интерес, Я мог бы сделать серию Rails Tutorial скринкастов использующую Haml для представлений. Это также учло бы введение в <a href="http://sass-lang.com/">Sass</a>, родственную Haml технологию, которая, если это в принципе возможно, является более ошеломляющей, чем Haml.&nbsp;<a class="arrow" href="#fnref:3.23">&uarr;</a></li>
<li id="fn:3.24">Если вы изучали Ruby прежде, вы могли бы подозревать, что <em>передает</em> содержимое в блок, и ваша догадка была бы правильной. Но для разработки веб-приложений с Rails это не имеет значения, и я, честно, никогда не заморачивался значением <tt class="verb">&lt;%= yield %&gt;</tt> я задумался об этом во второй раз&mdash;или даже в первый.&nbsp;<a class="arrow" href="#fnref:3.24">&uarr;</a></li>
</ol>
</div>

